<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Usando PHP y DTrace</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="features.dtrace.introduction.html">« Introducci&oacute;n a PHP y DTrace</a></li>
      <li style="float: right;"><a href="features.dtrace.systemtap.html">Usando SystemTap con Sondas Est&aacute;ticas en PHP DTrace »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="features.dtrace.html">Rastreo Din&aacute;mico con DTrace</a></li>
    <li>Usando PHP y DTrace</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="features.dtrace.dtrace" class="sect1">
  <h2 class="title">Usando PHP y DTrace</h2>
  <p class="para">
   PHP puede ser configurado con sondas estáticas DTrace en plataformas
   que soportan Rastreo Dinámico DTrace.
  </p>
  
  <div class="sect2" id="features.dtrace.install">
   <h3 class="title">Configurando PHP para Sondas Estáticas DTrace</h3>
   
   <p class="para">
    Refierase a la documentación externa específica par su plataforma
    para habilitar el soporte para rastreo DTrace en el sistema operativo.
    Por ejemplo, en Oracle Linux arranque con un kernel UEK3 y haga:
    
    <div class="informalexample">
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"># modprobe fasttrap<br /># chmod 666 /dev/dtrace/helper</span></code></div>
     </div>

    </div>
   </p>
   <p class="para">
    En lugar de utilizar <code class="literal">chmod</code>, usted podria utilizar
    una regla de paquete ACL para limitar acceso a los dispositivos a 
    ciertos usuarios.
   </p>
   
   <p class="para">
    Compile PHP con el parámetro de configuración <code class="literal">--enable-dtrace</code>:
    <div class="informalexample">
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000"># ./configure --enable-dtrace ...<br /># make<br /># make install</span></code></div>
     </div>

    </div>
   </p>
   <p class="para">
    Esto habilita las sondas estáticas en el núcleo de PHP. Cualquiera
    de las extensiones que ofrezcan sus propios sondeos deberán ser
    compiladas de forma separada como extensiones compartidas.
   </p>
  </div>
  
  <div class="sect2" id="features.dtrace.static-probes">
   <h3 class="title">Sondeos Estáticos DTrace en el núcleo de PHP</h3>
   <table class="doctable table">
    <caption><strong>Los siguientes sondeos estáticos están disponibles en PHP</strong></caption>
    
     <thead>
      <tr>
       <th>Nombre del Sondeo</th>
       <th>Descripción del Sondeo</th>
       <th>Argumentos del Sondeo</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td><code class="literal">request-startup</code></td>
       <td>Se dispara cuando comienza una petición.</td>
       <td>char *<var class="varname">file</var>, char *<var class="varname">request_uri</var>, char *<var class="varname">request_method</var></td>
      </tr>

      <tr>
       <td><code class="literal">request-shutdown</code></td>
       <td>Se dispara cuando se termina una petición.</td>
       <td>char *<var class="varname">file</var>, char *<var class="varname">request_uri</var>, char *<var class="varname">request_method</var></td>
      </tr>

      <tr>
       <td><code class="literal">compile-file-entry</code></td>
       <td>Se dispara cuando la compilación de un script comienza.</td>
       <td>char *<var class="varname">compile_file</var>, char *<var class="varname">compile_file_translated</var></td>
      </tr>

      <tr>
       <td><code class="literal">compile-file-return</code></td>
       <td>Se dispara cuando la compilación de un script termina.</td>
       <td>char *<var class="varname">compile_file</var>, char *<var class="varname">compile_file_translated</var></td>
      </tr>

      <tr>
       <td><code class="literal">execute-entry</code></td>
       <td>Se dispara cuando un código de operación array está por ser ejecutado.  
        Por ejemplo, se dispara en llamadas a funciones, includes, y continuaciones de resumes.
       </td>
       <td>char *<var class="varname">request_file</var>, int <var class="varname">lineno</var></td>
      </tr>

      <tr>
       <td><code class="literal">execute-return</code></td>
       <td>Se dispara después de la ejecución de un código de operación array.</td>
       <td>char *<var class="varname">request_file</var>, int <var class="varname">lineno</var></td>
      </tr>

      <tr>
       <td><code class="literal">function-entry</code></td>
       <td>Se dispara cuando el motor de PHP entra a la llamada de una función o método.</td>
       <td>char *<var class="varname">function_name</var>, char *<var class="varname">request_file</var>, int <var class="varname">lineno</var>, char *<var class="varname">classname</var>, char *<var class="varname">scope</var></td>
      </tr>

      <tr>
       <td><code class="literal">function-return</code></td>
       <td>Se dispara cuando el motor de PHP regresa de la llamada a una función o método.</td>
       <td>char *<var class="varname">function_name</var>, char *<var class="varname">request_file</var>, int <var class="varname">lineno</var>, char *<var class="varname">classname</var>, char *<var class="varname">scope</var></td>
      </tr>

      <tr>
       <td><code class="literal">exception-thrown</code></td>
       <td>Se dispara cuando una excepción es lanzada.</td>
       <td>char *<var class="varname">classname</var></td>
      </tr>

      <tr>
       <td><code class="literal">exception-caught</code></td>
       <td>Se dispara cuando una excepción es capturada.</td>
       <td>char *<var class="varname">classname</var></td>
      </tr>

      <tr>
       <td><code class="literal">error</code></td>
       <td>Se dispara cuando ocurre un error, sin importar el nivel de <a href="errorfunc.configuration.html#ini.error-reporting" class="link">error_reporting</a>.</td>
       <td>char *<var class="varname">errormsg</var>, char *<var class="varname">request_file</var>, int <var class="varname">lineno</var></td>
      </tr>

     </tbody>
    
   </table>

   <p class="para">
    Otras extensiones PHP pueden también tener otras sondas estáticas adicionales.
   </p>
  </div>
  
  <div class="sect2" id="features.dtrace.list-probes">
   <h3 class="title">Listando Sondas Estáticas DTrace en PHP</h3>
   <p class="para">
    Para listar todas las sondas disponibles, inicie un proceso PHP y ejecute:
    <div class="informalexample">
     <div class="example-contents">
<div class="cdata"><pre>
# dtrace -l
</pre></div>
     </div>

    </div>
   </p>
   
   <p class="para">
    La salida será similar a:
    <div class="informalexample">
     <div class="example-contents">
<div class="cdata"><pre>
   ID   PROVIDER            MODULE                          FUNCTION NAME
   [ . . . ]
    4   php15271               php               dtrace_compile_file compile-file-entry
    5   php15271               php               dtrace_compile_file compile-file-return
    6   php15271               php                        zend_error error
    7   php15271               php  ZEND_CATCH_SPEC_CONST_CV_HANDLER exception-caught
    8   php15271               php     zend_throw_exception_internal exception-thrown
    9   php15271               php                 dtrace_execute_ex execute-entry
   10   php15271               php           dtrace_execute_internal execute-entry
   11   php15271               php                 dtrace_execute_ex execute-return
   12   php15271               php           dtrace_execute_internal execute-return
   13   php15271               php                 dtrace_execute_ex function-entry
   14   php15271               php                 dtrace_execute_ex function-return
   15   php15271               php              php_request_shutdown request-shutdown
   16   php15271               php               php_request_startup request-startup
</pre></div>
     </div>

    </div>
   </p>
   
   <p class="para">
    La columna Proveedor consiste en <code class="literal">php</code> y el
    id del proceso del proceso PHP que está ejecutandose.
   </p>
   
   <p class="para">
    Si el servidor web Apache está corriendo, el nombre del módulo será,
    por ejemplo, <var class="filename">libphp5.so</var>, y habría múltiples
    bloques de listado, uno por cada proceso Apache ejecutandose.
   </p>
   
   <p class="para">
    La columna Función se refiere los nombres internos de función de su 
    implementación en C, donde cada proveedor está ubicado.
   </p>
   
   <p class="para">
    Si un proceso PHP no está ejecutandose, entonces ningún sondeo será
    mostrado.
   </p>
  </div>
  
  <div class="sect2" id="features.dtrace.examples">
   <h3 class="title">DTrace con un ejemplo PHP</h3>
   <p class="para">
    Este ejemplo muestra los conceptos básicos del lenguaje de scripting DTrace D.
    <div class="example" id="example-500">
     <p><strong>Ejemplo #1 <var class="filename">all_probes.d</var> para monitorizar todos los Śondeos Estáticos en PHP con DTrace</strong></p>
     <div class="example-contents">
<div class="cdata"><pre>
#!/usr/sbin/dtrace -Zs

#pragma D option quiet

php*:::compile-file-entry
{
    printf(&quot;PHP compile-file-entry\n&quot;);
    printf(&quot;  compile_file              %s\n&quot;, copyinstr(arg0));
    printf(&quot;  compile_file_translated   %s\n&quot;, copyinstr(arg1));
}

php*:::compile-file-return
{
    printf(&quot;PHP compile-file-return\n&quot;);
    printf(&quot;  compile_file              %s\n&quot;, copyinstr(arg0));
    printf(&quot;  compile_file_translated   %s\n&quot;, copyinstr(arg1));
}

php*:::error
{
    printf(&quot;PHP error\n&quot;);
    printf(&quot;  errormsg                  %s\n&quot;, copyinstr(arg0));
    printf(&quot;  request_file              %s\n&quot;, copyinstr(arg1));
    printf(&quot;  lineno                    %d\n&quot;, (int)arg2);
}

php*:::exception-caught
{
    printf(&quot;PHP exception-caught\n&quot;);
    printf(&quot;  classname                 %s\n&quot;, copyinstr(arg0));
}

php*:::exception-thrown
{
    printf(&quot;PHP exception-thrown\n&quot;);
    printf(&quot;  classname                 %s\n&quot;, copyinstr(arg0));
}

php*:::execute-entry
{
    printf(&quot;PHP execute-entry\n&quot;);
    printf(&quot;  request_file              %s\n&quot;, copyinstr(arg0));
    printf(&quot;  lineno                    %d\n&quot;, (int)arg1);
}

php*:::execute-return
{
    printf(&quot;PHP execute-return\n&quot;);
    printf(&quot;  request_file              %s\n&quot;, copyinstr(arg0));
    printf(&quot;  lineno                    %d\n&quot;, (int)arg1);
}

php*:::function-entry
{
    printf(&quot;PHP function-entry\n&quot;);
    printf(&quot;  function_name             %s\n&quot;, copyinstr(arg0));
    printf(&quot;  request_file              %s\n&quot;, copyinstr(arg1));
    printf(&quot;  lineno                    %d\n&quot;, (int)arg2);
    printf(&quot;  classname                 %s\n&quot;, copyinstr(arg3));
    printf(&quot;  scope                     %s\n&quot;, copyinstr(arg4));
}

php*:::function-return
{
    printf(&quot;PHP function-return\n&quot;);
    printf(&quot;  function_name             %s\n&quot;, copyinstr(arg0));
    printf(&quot;  request_file              %s\n&quot;, copyinstr(arg1));
    printf(&quot;  lineno                    %d\n&quot;, (int)arg2);
    printf(&quot;  classname                 %s\n&quot;, copyinstr(arg3));
    printf(&quot;  scope                     %s\n&quot;, copyinstr(arg4));
}

php*:::request-shutdown
{
    printf(&quot;PHP request-shutdown\n&quot;);
    printf(&quot;  file                      %s\n&quot;, copyinstr(arg0));
    printf(&quot;  request_uri               %s\n&quot;, copyinstr(arg1));
    printf(&quot;  request_method            %s\n&quot;, copyinstr(arg2));
}

php*:::request-startup
{
    printf(&quot;PHP request-startup\n&quot;);
    printf(&quot;  file                      %s\n&quot;, copyinstr(arg0));
    printf(&quot;  request_uri               %s\n&quot;, copyinstr(arg1));
    printf(&quot;  request_method            %s\n&quot;, copyinstr(arg2));
}
</pre></div>
     </div>

    </div>
   </p>
   
   <p class="para">
    Este script utiliza la opción <code class="literal">-Z</code> en
    <var class="filename">dtrace</var>, permitiendo que se ejecute aún cuando
    no hay procesos PHP ejecutandose. Si esta opción se hubiese omitido
    el script hubiese terminado inmediatamente porque no sabría que los
    sondeos a ser monitorizados realmente son válidos.
   </p>
   
   <p class="para">
    Este script rastrea todas las sondas estáticas del núcleo
    de PHP y puntos de muestreo a lo largo de la duración de un script
    PHP que esté corriendo:
    <div class="informalexample">
     <div class="example-contents">
<div class="cdata"><pre>
# ./all_probes.d
</pre></div>
     </div>

    </div>
   </p>
   
   <p class="para">
    Ejecuta un script o aplicación PHP. El script D de monitorización
    mostrará los argumentos de cada sondeo según vayan sucediendo.
   </p>
   
   <p class="para">
    Cuando la monitorización está completada, el script D puede ser
    terminado con
    <code class="literal">^C</code>.
   </p>
   
   <p class="para">
    En máquinas con múltiples-CPU el orden de los sondeos podría no
    aparecer secuencialmente. Esto depende de en que CPU fue procesado,
    y como los hilos se mueven a través de las CPUs. Mostrar la fecha
    y hora del sondeo ayudará a reducir la confusión, por ejemplo:
    <div class="informalexample">
     <div class="example-contents">
<div class="cdata"><pre>
php*:::function-entry
{
      printf(&quot;%lld: PHP function-entry &quot;, walltimestamp);
      [ . . .]
}
</pre></div>
     </div>

    </div>
   </p>
  </div>
  
  <div class="sect2" id="features.dtrace.references">
   <h3 class="title">Vea también</h3>
   <ul class="simplelist">
    <li><a href="oci8.dtrace.html" class="link">OCI8 y Rastreo Dinámico DTrace</a></li>
   </ul>
  </div>
 </div></div></div></body></html>